{
	"$schema": "https://schema.railpack.com",
	"packages": {
		"node": "24"
	},
	"buildAptPackages": [
		"tree"
	],
	"steps": {
		"install": {
			"commands": [
				"...",
				"bundle config set deployment true",
				"bundle config set without development test",
				"bundle install --jobs 1"
			]
		},
		"install:node": {
			"commands": [
				"mkdir -p /app/react-client/node_modules/.cache",
				{
					"src": "package.json",
					"dest": "package.json"
				},
				{
					"src": "react-client/package.json",
					"dest": "react-client/package.json"
				},
				{
					"src": "react-client/pnpm-lock.yaml",
					"dest": "react-client/pnpm-lock.yaml"
				},
				"npm i -g corepack@latest && corepack enable && corepack prepare --activate",
				"pnpm railway-install",
			]
		},
		"build": {
			"inputs": [
				"...",
				{
					"step": "install:node",
					"include": [
						"."
					]
				}
			],
			"commands": [
				"...",
				"pnpm railway-deploy",
				"bundle exec rake assets:precompile"
			]
		},
		"release": {
			"inputs": [
				{
					"step": "packages:mise"
				},
				{
					"step": "install"
				},
				{
					"step": "install:node"
				},
				{
					"step": "build",
					"exclude": [
						"./react-client",
						"./test",
						"./.github",
					]
				}
			],
			"commands": [
				"tree -a -L 5",
				"bin/rake db:migrate"
			]
		}
	}
}
